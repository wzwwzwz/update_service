<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>摩西尔LED显示控制-更新</title>
    <link rel="Shortcut Icon" href="./images/logo.png" id="theme_logo">
    <link rel="stylesheet" href="./styles/cmzInput.css" />
    <link rel="stylesheet" href="./styles/page_index.css" id="theme_page" />
    <!-- 引入layui.css -->
    <link rel="stylesheet" href="./scripts/util/layui-v2.6.4/css/layui.css" media="all">
</head>

<body>
    <div id="page_container" class="page_update">
        <div class="main_content">
            <!-- modlue_name 表示模块名称 唯一性 -->
            <div id="upd_form" class="form" modlue_name=''>
                <!-- nodlue -->
                <div id="upd_modlue" class="upd_item_grp upd_single_item">
                    <div class="upd_title"> 模块</div>
                    <div class="upd_item">
                        <div id='upd_select_modlue' class="item_select"></div>
                    </div>
                </div>
                <textarea id="modlue_text" class="upd_block border_style upd_item_right" style="display: block;margin-top: 10px;" placeholder="请输入模块描述"></textarea>

                <!-- version -->
                <div id="upd_version" class="upd_item_grp">
                    <div class="upd_single_item">
                        <div class="upd_title">版本号</div>
                        <div class="upd_item">
                            <div id='upd_select_version' class="item_select"></div>
                        </div>
                        <!-- <div class="upd_btn">创建</div> -->
                        <!-- <div class="upd_btn">刷新</div> -->
                    </div>

                    <div class="version_time">
                        <div id="version_create_time" class="upd_margin_top upd_single_item">
                            <div class="upd_title">创建时间</div>
                            <span class="time_val upd_item"></span>
                        </div>
                        <div id="version_edit_time" class="upd_margin_top upd_single_item">
                            <div class="upd_title">修改时间</div>
                            <span class="time_val upd_item"></span>
                        </div>
                    </div>
                    <div class="version_record upd_margin_top" style="display: inline-flex;">
                        <div class="upd_title">修改记录</div>
                        <textarea id="version_text" class="upd_block border_style " style="margin-left: 20px;" placeholder="请输入版本记录"></textarea>
                    </div>
                </div>

                <!-- file -->
                <div id="upd_file" class="upd_item_grp">
                    <div class="upd_title">文件目录</div>
                    <input id="upd_file_input" type="file" value="选择目录" style="margin-left: 15px;width: 180px;" webkitdirectory directory onchange="on_file_chg(this)">
                </div>

                <div class="file_wrap upd_block border_style upd_item_right upd_margin_top">
                    <div id="file_text"></div>
                </div>

                <div id="file_onload" class="upd_item_right">
                    <span>加载文件进度</span>
                    <div class="mc_progress_bar_wrap">
                        <div id="" class="mc_progress_bar" style="width: 95.95px; background-color: red;height: 10px;"></div>
                    </div>
                </div>



                <div id="btn_submit">
                    <div id="status" style="text-align: left;"></div>
                    <div class="upd_btn" style="width: 100%;">提交</div>
                </div>
            </div>

            <!-- 测试 -->
            <div style="margin: 20px;display: none-;">
                <div id="add_record" class="upd_btn" onclick="add_record('module')">添加模块</div>
                <div id="add_record" class="upd_btn" onclick="add_record('version')">添加版本</div>
                <div id="add_record" class="upd_btn" onclick="add_record('file')">添加文件</div>
                <div id="add_record" class="upd_btn" onclick="version_test_set()">version_test_set</div>


            </div>
        </div>
    </div>

    <!-- 引入layui.js -->
    <script type="text/javascript" src="./scripts/util/layui-v2.6.4/layui.js" charset="utf-8"></script>
    <script type="text/javascript" src="./scripts/util/jquery-3.6.0.min.js"></script>
    <script type="text/javascript" src="./scripts/util/spark-md5.min.js"></script>
    <script type="text/javascript" src="./scripts/page_index.js"></script>
    <script type="text/javascript" src="./scripts/cmzInput.js"></script>

    <script>
        init_create_select()
        var g_obj_ui_update_dom = new ui_update_dom_val()
        var g_obj_update_servier = new construct_update_servier_data()


        // 初始化选项
        function init_create_select(dom, callback) {
            $('#upd_select_modlue').cmzSelect({
                id: 'id', // 唯一标识
                arr: [], // 数据源
                label: 'name', // input展示数据
                callback: on_val_chg_modlue, // 回调函数
                searchList: ['name'] // 模糊查询字段列表
            })

            $('#upd_select_version').cmzSelect({
                id: 'id', // 唯一标识
                arr: [], // 数据源
                label: 'name', // input展示数据
                callback: on_val_chg_version, // 回调函数
                searchList: ['name'] // 模糊查询字段列表
            })
        }


        // 选项更新; 下拉框选项标记, 选项数组, 当前选中的id
        function update_select(str, arr, cur_id) {
            if (typeof str === "string") {
                str = str.trim().toLocaleUpperCase();
            }

            var dom = null;
            var callback = null;
            switch (str) {
                case "MODULE":
                    dom = $('#upd_select_modlue');
                    callback = on_val_chg_modlue;
                    break;
                case "VERSION":
                    dom = $('#upd_select_version');
                    callback = on_val_chg_version;
                    break;
                default:
                    break;
            }

            if (dom && dom.length && typeof arr === "object" && typeof dom.cmzSelect === "function") {
                dom.cmzSelect({
                    id: 'id', // 唯一标识
                    arr: arr, // 数据源
                    currentId: cur_id, //当前选项id
                    label: 'name', // input展示数据
                    callback: callback, // 回调函数
                    searchList: ['name'] // 模糊查询字段列表
                });
            }
        }

        function on_val_chg_modlue(b_new, val) {
            console.log(val)
            if (b_new) {
                val = {
                    id: -1,
                    name: val
                }
            }
            g_obj_update_servier.on_module_chg(val)
        }

        function on_val_chg_version(b_new, val) {
            console.log(val)
            if (b_new) {
                val = {
                    id: -1,
                    name: val
                }
            }
            g_obj_update_servier.on_version_chg(val)
        }

        var g_test_req = new construct_update_req()



        // 文本框编辑
        $("textarea").on("blur", function (event) {
            console.log("文本失焦", event);
            if (event && event.target) {
                switch (event.target.id) {
                    case "modlue_text":
                        // g_obj_update_servier.on_module_disctipt_chg(this.value)
                        break;
                    case "version_text":
                        // g_obj_update_servier.on_version_disctipt_chg(this.value)
                        break;
                    default:
                        break;
                }
            }
        })

        document.getElementById("btn_submit").onclick = function () {
            g_obj_update_servier.commit()
        }

        function on_file_chg(dom) {
            // console.log("文件上传");
            var arr_file = dom.files || event.target.files
            var ui_file_len = arr_file.length
            if (ui_file_len) {
                var obj_menu = new construct_file_menu()
                obj_menu.set_file(arr_file)
                add_menu_tree(obj_menu.get_data(), true)
            }
        }

        add_menu_tree()

        function add_menu_tree(arr, b_save) {
            clear_file_input(b_save)
            layui.use('tree', function () {
                var defult = [{
                    //一级菜单
                    title: '江西',
                    children: [{
                        //二级菜单
                        title: '南昌',
                        children: [{
                            title: '高新区' //三级菜单 
                            //…… //以此类推，可无限层级
                        }]
                    }]
                }, {
                    //一级菜单
                    title: '陕西',
                    children: [{
                        title: '西安' //二级菜单
                    }]
                }]
                var data = arr || []
                console.log("[目录数据]", data);
                var tree = layui.tree;
                //渲染
                var inst1 = tree.render({
                    //绑定元素
                    elem: '#file_text',
                    data: data,
                    text: {
                        none: "暂无文件"
                    }
                });
            });
        }


        // 清空input选择的文件; b_save === true 时不清空
        function clear_file_input(b_save) {
            var obj_file_input = document.getElementById("upd_file_input");
            if (obj_file_input && !b_save) {
                obj_file_input.outerHTML = obj_file_input.outerHTML
            }
        };


        function update_progress(params) {
            var file_onload = document.getElementById("file_onload")
            file_onload.style.width = params + "px"
        }
    </script>

    <!-- 测试代码 -->
    <script>
        function add_record(type) {
            var arr = []
            switch (type) {
                case "module":
                    arr = obj_data_response.module_info.PARAMS
                    g_test_req.moudlue_info(arr, function () {
                        console.log("添加返回");
                    }, true)
                    break;
                case "version":
                    arr = obj_data_response.version_info
                    break;
                case "file":
                    arr = get_file_data()
                    g_test_req.moudlue_info(arr, function () {
                        console.log("添加返回");
                    }, true)
                    break;
                default:
                    break;
            }

            console.log(arr);
        }


        function get_file_data() {
            var params = [{
                "123698": "1",
                ATTRS: {
                    "INDEX": "-1",
                    "MODULE": "123698",
                    "VERSION": "1.0.5",
                    "LOG": "社会主义好\n共产主义好"
                }
            }]
            return params
        }

        function version_test_set() {
            let obj_req_json = {
                func: "version_info",
                cmd: "set",
                params: [{
                    "123698": "1",
                    ATTRS: {
                        "INDEX": "-1",
                        "MODULE": "123698",
                        "VERSION": "1.0.5",
                        "LOG": "社会主义好\n共产主义好"
                    }
                }]
            };

            $.ajax({
                url: "Api",
                data: JSON.stringify({
                    id: "456481686",
                    param: JSON.stringify(obj_req_json),
                    code: 2
                }),
                type: "post",
                contentType: "application/json",
                dataType: "json",
                success: function (obj_srv_dat) {

                },
                error: function (xhr, textStatus, errorThrown) {
                    console.log("failed msg : " + xhr.responseText);
                }
            });
        }
    </script>

</body>

</html>